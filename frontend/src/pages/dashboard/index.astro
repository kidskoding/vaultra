---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import MetricsChart from '../../components/MetricsChart';
---
<DashboardLayout title="Dashboard">
  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-semibold text-claude-text tracking-tight">Overview</h1>
      <p class="text-sm text-claude-text-secondary mt-1">Your funding readiness at a glance.</p>
    </div>

    <div id="score-section">
      <div class="bg-claude-surface rounded-2xl border border-claude-border p-6 animate-pulse">
        <div class="h-4 bg-claude-bg-tertiary rounded w-1/4 mb-4"></div>
        <div class="h-16 bg-claude-bg-tertiary rounded w-1/3"></div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <MetricsChart client:load type="revenue" />
      <MetricsChart client:load type="chargebacks" />
    </div>
  </div>
</DashboardLayout>

<script>
  import { getReadinessScore } from '../../lib/api';
  import { getCurrentBusinessId } from '../../lib/auth';

  const bid = getCurrentBusinessId();
  if (bid) {
    getReadinessScore(bid).then((data: any) => {
      const section = document.getElementById('score-section');
      if (!section) return;
      const tierLabels: Record<string, string> = {
        not_ready: 'Not ready',
        improving: 'Improving',
        funding_ready: 'Funding-ready',
        highly_attractive: 'Highly attractive',
      };
      const tierColors: Record<string, { bg: string; text: string }> = {
        not_ready: { bg: 'bg-red-500/20', text: 'text-red-400' },
        improving: { bg: 'bg-amber-500/20', text: 'text-amber-400' },
        funding_ready: { bg: 'bg-[#da7756]/20', text: 'text-[#da7756]' },
        highly_attractive: { bg: 'bg-emerald-500/20', text: 'text-emerald-400' },
      };
      const colors = tierColors[data.tier] || { bg: 'bg-[#3c3836]', text: 'text-[#a8a29e]' };
      section.innerHTML = `
        <div class="bg-[#292524] rounded-2xl border border-[#44403c] p-6 animate-fade-in">
          <p class="text-sm font-medium text-[#a8a29e]">Funding Readiness Score</p>
          <div class="mt-3 flex items-end gap-3">
            <span class="text-6xl font-bold text-[#ede9e3]">${data.score}</span>
            <span class="text-2xl text-[#78716c] mb-2">/100</span>
          </div>
          <div class="mt-4">
            <span class="px-4 py-1.5 rounded-full text-sm font-medium ${colors.bg} ${colors.text}">
              ${tierLabels[data.tier] ?? data.tier}
            </span>
          </div>
        </div>`;
    }).catch(() => {
      const section = document.getElementById('score-section');
      if (section) {
        section.innerHTML =
          '<div class="bg-[#292524] rounded-2xl border border-[#44403c] p-6 text-sm text-[#a8a29e] animate-fade-in">No score yet â€” connect Stripe to get started.</div>';
      }
    });
  }
</script>
